<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç¾é£Ÿè¾¨è­˜</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');
    body {
      font-family: 'Nunito', sans-serif;
      margin: 20px;
      background: #FFF8DC;
      text-align: center;
    }
    .container {
      display: inline-block;
      width: 480px;
      background: #FFF;
      border: 2px solid #D2B48C;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(210,180,140,0.4);
      padding: 24px;
      text-align: left;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #8B4513;
      font-size: 2rem;
      font-weight: 700;
    }
    .input-group {
      margin-bottom: 16px;
    }
    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 700;
      color: #8B4513;
    }
    .input-group input[type="text"], .input-group input[type="file"] {
      width: 100%;
      padding: 8px;
      border: 2px dashed #C19A6B;
      border-radius: 12px;
      background: #FFF8DC;
      font-size: 1rem;
    }
    .preview {
      display: block;
      width: 100%;
      margin: 12px 0;
      border: 2px dashed #C19A6B;
      border-radius: 12px;
      object-fit: contain;
      background: #FFF8DC;
    }
    .btn-group {
      display: flex;
      gap: 12px;
      margin: 16px 0;
    }
    button {
      flex: 1;
      padding: 12px;
      font-size: 1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s;
      font-weight: 700;
    }
    button:hover {
      transform: scale(1.05);
    }
    .primary { background-color: #C19A6B; color: white; }
    .secondary { background-color: #EED5B7; color: #8B4513; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .result {
      margin-top: 16px;
      padding: 12px;
      background: #FFF5EE;
      border: 1px solid #EED5B7;
      border-radius: 12px;
      color: #333;
    }
    .result p { margin: 8px 0; font-size: 1rem; }
  </style>
</head>
<body>
  <h1>ç¾é£Ÿè¾¨è­˜ ğŸ”ğŸ°</h1>
  <div class="container">
    <div class="input-group">
      <label for="imageFile">è«‹ä¸Šå‚³åœ–ç‰‡</label>
      <input type="file" id="imageFile" accept="image/*" />
    </div>
    <button class="secondary" onclick="handleInput()">åˆ†æåœ–ç‰‡</button>
    <img id="imagePreview" class="preview" src="" alt="å°šæœªä¸Šå‚³åœ–ç‰‡" />
    <div class="btn-group">
      <button class="secondary" onclick="showNutrition()" id="nutritionBtn" disabled>ğŸ æŸ¥çœ‹ç†±é‡ï¼†è›‹ç™½è³ª</button>
      <button class="secondary" onclick="showRestaurants()" id="restaurantBtn" disabled>ğŸ  æ¨è–¦é¤å»³</button>
    </div>
    <div class="result" id="resultArea" style="display:none;">
      <p id="nutritionResult"></p>
      <p id="restaurantResult"></p>
    </div>
  </div>

  <script>
  let currentImage = "";
  let analysisResult = null;

  function handleInput() {
    const fileInput = document.getElementById("imageFile").files[0];
    const preview = document.getElementById("imagePreview");

    if (!fileInput) {
      alert("è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ");
      return;
    }

    // æª¢æŸ¥æª”æ¡ˆæ ¼å¼
    const fileTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp'];
    if (!fileTypes.includes(fileInput.type)) {
      alert("è«‹ä¸Šå‚³æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆï¼ˆ.jpg, .png, .gif, .bmpï¼‰");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      currentImage = e.target.result;
    };
    reader.readAsDataURL(fileInput);
    console.log("é–‹å§‹åˆ†æä¸Šå‚³åœ–ç‰‡:", fileInput.name);
    analyzeImage(fileInput);

  }

  async function analyzeImage(file) {
    try {
    const formData = new FormData();
    formData.append("image", file);

    console.log("ç™¼é€è«‹æ±‚åˆ° /analyze_upload");
    const response = await fetch("/analyze_upload", {
      method: "POST",
      body: formData
    });

      if (!response.ok) {
        const errorData = await response.json();
        console.error("å¾Œç«¯å›æ‡‰éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼:", response.status, "è¨Šæ¯:", errorData);
        alert(errorData.error || "åœ–ç‰‡è¾¨è­˜å¤±æ•—ï¼Œè«‹ç¢ºèªè¼¸å…¥æ˜¯å¦æ­£ç¢ºï¼ˆå¿…é ˆæ˜¯ .jpg æˆ– .png æª”æ¡ˆï¼‰");
        return;
      }

      analysisResult = await response.json();
      console.log("å¾Œç«¯å›å‚³è³‡æ–™:", analysisResult);

      // é©—è­‰è³‡æ–™æ ¼å¼
      if (!analysisResult || !analysisResult.english || !analysisResult.chinese || 
          analysisResult.calories == null || analysisResult.protein == null || 
          !Array.isArray(analysisResult.restaurants)) {
        console.error("å¾Œç«¯è³‡æ–™æ ¼å¼ä¸æ­£ç¢º:", analysisResult);
        alert("å¾Œç«¯å›å‚³è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡");
        return;
      }

      // å•Ÿç”¨æŒ‰éˆ•
      document.getElementById("nutritionBtn").disabled = false;
      document.getElementById("restaurantBtn").disabled = false;
      console.log("æŒ‰éˆ•å·²å•Ÿç”¨");

      // æ¸…ç©ºçµæœ
      document.getElementById("resultArea").style.display = "none";
      document.getElementById("nutritionResult").innerHTML = "";
      document.getElementById("restaurantResult").innerHTML = "";

    } catch (error) {
      console.error("åˆ†æå¤±æ•—:", error);
      alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¼¸å…¥æ­£ç¢ºçš„åœ–ç‰‡ URL/æª”æ¡ˆ");
    }
  }

  function showNutrition() {
    if (!analysisResult) {
      console.error("æœªæ‰¾åˆ°åˆ†æçµæœ");
      alert("è«‹å…ˆè¼‰å…¥ä¸¦åˆ†æåœ–ç‰‡");
      return;
    }

    console.log("é¡¯ç¤ºç‡Ÿé¤Šè³‡è¨Š");
    document.getElementById("resultArea").style.display = "block";
    document.getElementById("nutritionResult").innerHTML = `
      <p>ğŸ” <strong>è¾¨è­˜çµæœï¼ˆEnglishï¼‰:</strong> ${analysisResult.english}</p>
      <p>ğŸ”¤ <strong>ç¿»è­¯çµæœ:</strong> ${analysisResult.chinese.join(", ")}</p>
      <p>ğŸ”¥ <strong>ç†±é‡:</strong> ${analysisResult.calories} kcal</p>
      <p>ğŸ’ª <strong>è›‹ç™½è³ª:</strong> ${analysisResult.protein} g</p>
    `;
    document.getElementById("restaurantResult").innerHTML = "";
  }

  function showRestaurants() {
    if (!analysisResult) {
      console.error("æœªæ‰¾åˆ°åˆ†æçµæœ");
      alert("è«‹å…ˆè¼‰å…¥ä¸¦åˆ†æåœ–ç‰‡");
      return;
    }

    console.log("é¡¯ç¤ºé¤å»³è³‡è¨Š");
    document.getElementById("resultArea").style.display = "block";
    document.getElementById("nutritionResult").innerHTML = "";
    document.getElementById("restaurantResult").innerHTML = `
      <p>ğŸ  <strong>æ¨è–¦é¤å»³:</strong>
        <ul>
          ${analysisResult.restaurants.length > 0 
            ? analysisResult.restaurants.map(r => `<li>${r}</li>`).join("") 
            : "<li>ç„¡æ¨è–¦</li>"}
        </ul>
      </p>
    `;
  }
  </script>
</body>
</html>